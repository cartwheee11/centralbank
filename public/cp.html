<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="/css/Skeleton-2.0.4/css/normalize.css">
  <link rel="stylesheet" href="/css/Skeleton-2.0.4/css/skeleton.css">
  <style>
    body {
      background: rgb(248, 248, 250);
    }

    

    p {
      font-size: 20px;
    }

    .add-user-container input, .add-user-container button {
      width: 100%;
    }

    .user button{
      margin-bottom: 0;
    }

    .bun-button {
      margin-right: 10px;
    }

    .add-user-container .row{
      background-color: white;
      padding: 30px;
      border-radius: 20px;
    }

    .add-user-container button {
      margin-bottom: 0;
    }

    .cp-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .user {
      background-color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
    }

    .users {

    }

    .sub {
      background-color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
    }

    .sub input, .sub button {
      margin-right: 10px;
      margin-bottom: 0;
      margin-top: 10px;
    }

    .users > h2{
      margin-top: 30px !important
    }

    @media screen and (max-width: 800px) {
      .cp-wrapper {
        grid-template-columns: 1fr;
      }

      html {
        zoom: 0.7;
      }
    }
  </style>
</head>
<body>
  <a href="Login.html" style="position: fixed; bottom: 10px; right: 10px; background-color: #f5cb7c; padding: 10px 20px; color: #6a4808; border-radius: 100px; box-shadow: 0px 7px 21px 0 rgba(34, 60, 80, 0.2); font-family: helvetica;">В личный кабинет</a>
  <div class="cp-wrapper container-fluid">
    <div class="submissions" style="display: inline-block;" ><h2>Заявки</h2></div>
    <div class="users" style="display: inline-block; vertical-align: top;" >
      <div class="add-user-container">
        <h2>Добавить пользователя</h2>
        <div class="row">
          <div class="one-half column">
            <input class="add-nickname" type="text" placeholder="Никнейм"> <input class="add-ICN" type="text" placeholder="ICN">
            <input class="add-reason" type="text" placeholder="Причина обращения">
            
          </div>
          <div class="one-half column">
            <input class="add-registration" type="text" placeholder="Регистрация">  
            <input class="add-email" type="text" placeholder="email">
          </div>
          <button class="add-button button-primary" style="width: 100%">Добавить</button>  
          
          
        </div>
        
        <br>
      </div>
      <h2>Список пользователей</h2>
    </div>
  </div>

  
  <script type="module" src="./js/api.js"></script>
  <script type="module" type="text/javascript">
    const submissionsDOM = document.querySelector('.submissions');

    import * as api from "./js/api.js";
    api.getCpData().then(res => {
      if(res.success) {
        console.log(res.submissions);
        const subs = res.submissions;
        const users = res.users;

        subs.forEach(sub => {
          const data = sub.data;

          const el = document.createElement('div');

          const subInfo = document.createElement('p');

          const allowButton = document.createElement('button');
          allowButton.innerText = 'Одобрить'
          allowButton.className = 'button-primary'

          const rejectButton = document.createElement('button');
          rejectButton.innerText = 'Удалить'
          
          rejectButton.onclick = () => {
            el.style = 'padding-bottom: 30px; opacity: 0.5 !important';
            api.removeSubmission(sub.ref['@ref'].id).then(res => {
              if(res.success) {
                // location.reload();
                el.style="display: none";
              } else {
                alert(res.message)
              }
            })
          }

          const regInput = document.createElement('input');
          regInput.placeholder = 'задать регистрацию'
          regInput.type = 'text';
          const passInput = document.createElement('input');
          passInput.type = 'text'
          passInput.placeholder = 'задать ICN';
          allowButton.onclick = () => {
            console.log('клик клик')
            const pass = passInput.value;
            const registration = regInput.value;


            const { name, email, reason } = data;
            console.log(pass, registration, name, email, reason);
            api.register(name, email, reason, pass, registration).then((res) => {
              if(res.success) {
                console.log(sub.ref['@ref'].id);
                api.removeSubmission(sub.ref['@ref'].id).then((res) => {
                  if(!res.success) {
                    alert('удаление заявки не состоялось')
                  } else {
                    location.reload();
                  }
                })
              } else {
                alert(res.message);
              }
            })
          }
          subInfo.innerText = `E-mail: ${data.email}\nИмя: ${data.name}\nПричина обращения: ${data.reason}\n`
          el.style = 'padding-bottom: 30px';
          el.className = 'sub'
          el.append(subInfo)
          el.append(regInput)
          el.append(passInput)
          el.append(allowButton)
          el.append(rejectButton)

          submissionsDOM.append(el);
        })

        const usersDOM = document.querySelector('.users');
        users.forEach(user => {
          const data = user.data;
          
          const el = document.createElement('div');
          el.style='padding-bottom: 30px';

          const { nickname, email, reason, pass, registration, deposit, role} = data;

          const about =  document.createElement('p');
          about.innerText = `Никнейм: ${nickname}\nICN: ${pass}\nEmail: ${email}\nРегистрация: ${registration}\nВклад: ${deposit}\nРоль: ${role}\n`
          const bunButton = document.createElement('button');
          bunButton.innerText = 'Удалить игрока'
          bunButton.className="bun-button"
          bunButton.onclick = () => {
            el.style='padding-bottom: 30px; opacity: 0.5';
            api.removeUser(user.ref['@ref'].id).then(res => {
              if(!res.success) {
                alert('удаление пользователя не состоялось')
              } else {
                // location.reload();
                el.style='display: none';
              }
            })
          }

          const editButton = document.createElement('button');
          editButton.innerText = 'Изменить';
          editButton.onclick = () => {
            editButton.disabled = true;

            const editNickname = document.createElement('input')
            editNickname.placeholder = 'Никнейм';
            editNickname.type = 'text'

            const editPass = document.createElement('input')
            editPass.placeholder = 'ICN';
            editPass.type = 'text'

            // const eiditReason = document.createElement('input')
            // eiditReason.placeholder = 'Причина заявки';

            const editEmail = document.createElement('input')
            editEmail.placeholder = 'E-mail';
            editEmail.type = 'text'

            const editRole = document.createElement('input')
            editRole.placeholder = 'Роль';
            editRole.type = 'text'

            const editDeposit = document.createElement('input')
            editDeposit.placeholder = 'Вклад';
            editDeposit.type = 'text'

            const editRegistration = document.createElement('input')
            editRegistration.placeholder = 'Регистрация';
            editRegistration.type = 'text'

            const doEdit = document.createElement('button')
            doEdit.innerText= 'Применить';

            doEdit.onclick = () => {
              editButton.disabled = true;
              el.style = 'padding-bottom: 30px; opacity: 0.5';
              api.editUser(user.ref['@ref'].id, {
                nickname: editNickname.value || undefined,
                pass: editPass.value || undefined,
                email: editEmail.value || undefined,
                role: editRole.value || undefined,
                deposit: editDeposit.value || undefined,
                registration: editRegistration.value || undefined,

              }).then(res => {
                if(res.success) {
                  el.style = 'padding-bottom: 30px; opacity: 1';
                  about.innerText = `Никнейм: ${res.data.nickname}\nICN: ${res.data.pass}\nEmail: ${res.data.email}\nРегистрация: ${res.data.registration}\nВклад: ${res.data.deposit}\nРоль: ${res.data.role}\n`
                  editButton.disabled = false;

                  editNickname.value = '';
                  editPass.value = '';
                  editEmail.value = '';
                  editRole.value = '';
                  editDeposit.value = '';
                  editRegistration.value = '';
                } else {
                  el.style = 'padding-bottom: 30px; opacity: 1';                  
                  alert(res.message)
                }
              })
            }

            const br = () => {
              return document.createElement('br');
            } 

            el.append(br(), editNickname, br(), editPass, br(), editEmail, br(), editRole, br(), editDeposit, br(), editRegistration, br(), doEdit)

          }

          el.append(about);
          el.append(bunButton);
          el.append(editButton)
          el.className = 'user'
          usersDOM.append(el);
        })

      } else {
        alert(res.message);
      }
    })

    const addNickname = document.querySelector(".add-nickname");
    const addPass = document.querySelector(".add-ICN");
    const addRegistration = document.querySelector(".add-registration");
    const addEmail = document.querySelector(".add-email");
    const addButton = document.querySelector(".add-button");
    const addReason = document.querySelector(".add-reason");

    addButton.onclick = () => {
      const nickname = addNickname.value;
      const pass = addPass.value;
      const registration = addRegistration.value;
      const email = addEmail.value;
      const reason = addReason.value;
      api.register(nickname, email, reason, pass, registration).then(res => {
        if(res.success) {
          addButton.innerText = 'Подождите...'
          location.reload()
        } else {
          alert(JSON.stringify(res.message))
        }
      })
    }

  </script>
</body>
</html>