<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>

  <div class="container" style="width: 100%; margin: 0 auto; border: 1px solid red">
    <div class="submissions" style="display: inline-block; width: 49%" ><h1>Заявки</h1></div>
    <div class="users" style="display: inline-block; width: 49%; vertical-align: top;" >
      <h1>Добавить пользователя</h1>
      <p><input class="add-nickname" type="text" placeholder="Никнейм"></p>
      <p><input class="add-ICN" type="text" placeholder="ICN"></p>
      <p><input class="add-reason" type="text" placeholder="Причина обращения"></p>
      <p><input class="add-registration" type="text" placeholder="Регистрация"></p>
      <p><input class="add-email" type="text" placeholder="email"></p>
      <button class="add-button">Добавить</button>
      <br>
      <h1>Список пользователей</h1>
    </div>
  </div>

  
  <script type="module" src="./js/api.js"></script>
  <script type="module" type="text/javascript">
    const submissionsDOM = document.querySelector('.submissions');

    import * as api from "./js/api.js";
    api.getCpData().then(res => {
      if(res.success) {
        console.log(res.submissions);
        const subs = res.submissions;
        const users = res.users;

        subs.forEach(sub => {
          const data = sub.data;

          const el = document.createElement('div');

          const subInfo = document.createElement('p');

          const allowButton = document.createElement('button');
          allowButton.innerText = 'Одобрить'

          const rejectButton = document.createElement('button');
          rejectButton.innerText = 'Удалить'
          
          rejectButton.onclick = () => {
            el.style = 'padding-bottom: 30px; opacity: 0.5 !important';
            api.removeSubmission(sub.ref['@ref'].id).then(res => {
              if(res.success) {
                // location.reload();
                el.style="display: none";
              } else {
                alert(res.message)
              }
            })
          }

          const regInput = document.createElement('input');
          regInput.placeholder = 'задать регистрацию'
          const passInput = document.createElement('input');
          passInput.placeholder = 'задать ICN';
          allowButton.onclick = () => {
            console.log('клик клик')
            const pass = passInput.value;
            const registration = regInput.value;


            const { name, email, reason } = data;
            console.log(pass, registration, name, email, reason);
            api.register(name, email, reason, pass, registration).then((res) => {
              if(res.success) {
                console.log(sub.ref['@ref'].id);
                api.removeSubmission(sub.ref['@ref'].id).then((res) => {
                  if(!res.success) {
                    alert('удаление заявки не состоялось')
                  } else {
                    location.reload();
                  }
                })
              } else {
                alert(res.message);
              }
            })
          }
          subInfo.innerText = `E-mail: ${data.email}\nИмя: ${data.name}\nПричина обращения: ${data.reason}\n`
          el.style = 'padding-bottom: 30px';
          el.append(subInfo)
          el.append(regInput)
          el.append(passInput)
          el.append(allowButton)
          el.append(rejectButton)

          submissionsDOM.append(el);
        })

        const usersDOM = document.querySelector('.users');
        users.forEach(user => {
          const data = user.data;
          
          const el = document.createElement('div');
          el.style='padding-bottom: 30px';

          const { nickname, email, reason, pass, registration, deposit, role} = data;

          const about =  document.createElement('p');
          about.innerText = `${nickname}\nICN: ${pass}\nEmail: ${email}\nРегистрация: ${registration}\nВклад: ${deposit}\nРоль: ${role}\n`
          const bunButton = document.createElement('button');
          bunButton.innerText = 'Удалить игрока'
          bunButton.onclick = () => {
            el.style='padding-bottom: 30px; opacity: 0.5';
            api.removeUser(user.ref['@ref'].id).then(res => {
              if(!res.success) {
                alert('удаление пользователя не состоялось')
              } else {
                // location.reload();
                el.style='display: none';
              }
            })
          }

          const editButton = document.createElement('button');
          editButton.innerText = 'Изменить';
          editButton.onclick = () => {
            editButton.disabled = true;

            const editNickname = document.createElement('input')
            editNickname.placeholder = 'Никнейм';

            const editPass = document.createElement('input')
            editPass.placeholder = 'ICN';

            // const eiditReason = document.createElement('input')
            // eiditReason.placeholder = 'Причина заявки';

            const editEmail = document.createElement('input')
            editEmail.placeholder = 'E-mail';

            const editRole = document.createElement('input')
            editRole.placeholder = 'Роль';

            const editDeposit = document.createElement('input')
            editDeposit.placeholder = 'Вклад';

            const editRegistration = document.createElement('input')
            editRegistration.placeholder = 'Регистрация';

            const doEdit = document.createElement('button')
            doEdit.innerText= 'Применить';

            doEdit.onclick = () => {
              editButton.disabled = true;
              el.style = 'padding-bottom: 30px; opacity: 0.5';
              api.editUser(user.ref['@ref'].id, {
                nickname: editNickname.value || undefined,
                pass: editPass.value || undefined,
                email: editEmail.value || undefined,
                role: editRole.value || undefined,
                deposit: editDeposit.value || undefined,
                registration: editRegistration.value || undefined,

              }).then(res => {
                if(res.success) {
                  el.style = 'padding-bottom: 30px; opacity: 1';
                  about.innerText = `${res.data.nickname}\nICN: ${res.data.pass}\nEmail: ${res.data.email}\nРегистрация: ${res.data.registration}\nВклад: ${res.data.deposit}\nРоль: ${res.data.role}\n`
                  editButton.disabled = false;

                  editNickname.value = '';
                  editPass.value = '';
                  editEmail.value = '';
                  editRole.value = '';
                  editDeposit.value = '';
                  editRegistration = '';
                } else {
                  el.style = 'padding-bottom: 30px; opacity: 1';                  
                  alert(res.message)
                }
              })
            }

            const br = () => {
              return document.createElement('br');
            } 

            el.append(br(), editNickname, br(), editPass, br(), editEmail, br(), editRole, br(), editDeposit, br(), editRegistration, br(), doEdit)

          }

          el.append(about);
          el.append(bunButton);
          el.append(editButton)
          usersDOM.append(el);
        })

      } else {
        alert(res.message);
      }
    })

    const addNickname = document.querySelector(".add-nickname");
    const addPass = document.querySelector(".add-ICN");
    const addRegistration = document.querySelector(".add-registration");
    const addEmail = document.querySelector(".add-email");
    const addButton = document.querySelector(".add-button");
    const addReason = document.querySelector(".add-reason");

    addButton.onclick = () => {
      const nickname = addNickname.value;
      const pass = addPass.value;
      const registration = addRegistration.value;
      const email = addEmail.value;
      const reason = addReason.value;
      api.register(nickname, email, reason, pass, registration).then(res => {
        if(res.success) {
          addButton.innerText = 'Подождите...'
          location.reload()
        } else {
          alert(JSON.stringify(res.message))
        }
      })
    }

  </script>
</body>
</html>